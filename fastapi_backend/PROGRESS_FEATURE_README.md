# 预处理进度条功能说明

本文档说明了新添加的预处理和特征提取进度条功能。

## 功能概述

### 新增功能
1. **实时进度监控** - 预处理和特征提取过程的实时进度显示
2. **状态管理** - 数据库中记录每个数据的处理状态
3. **前端进度条** - 可视化显示处理进度和状态
4. **批量处理监控** - 支持批量预处理的进度跟踪

### 状态说明
- `pending` - 待处理
- `processing` - 处理中
- `completed` - 已完成
- `failed` - 处理失败

## 数据库更新

### 新增字段
在 `tb_data` 表中添加了两个新字段：
- `processing_status` - 预处理状态
- `feature_status` - 特征提取状态

### 运行数据库更新脚本
```bash
cd fastapi_backend
python update_database.py
```

该脚本会：
1. 自动添加新的状态字段
2. 根据现有特征图片更新已处理数据的状态
3. 生成详细的日志记录

## API 更新

### 新增端点
1. `GET /data/progress/{data_id}` - 获取单个数据的处理进度
2. `GET /data/progress?data_ids=1,2,3` - 获取批量数据的处理进度
3. `PUT /data/status/{data_id}` - 更新数据处理状态（内部API）

### 修改的端点
- `POST /data/{data_id}/preprocess` - 现在会更新数据库状态
- `POST /data/batch-preprocess` - 现在会更新数据库状态

## 前端更新

### 新增组件
1. `ProgressBar` - 进度条组件
2. `ProgressModal` - 进度监控弹窗

### 更新的页面
- `DataManagePage` - 添加了状态列和进度监控功能

### 新增功能
1. **状态列** - 表格中显示每个数据的处理状态和进度
2. **进度弹窗** - 点击预处理按钮后显示详细进度
3. **自动刷新** - 进度窗口会自动刷新状态
4. **状态图标** - 不同状态有对应的图标和颜色

## 使用说明

### 单个数据预处理
1. 在数据管理页面点击单个数据的"预处理"按钮
2. 确认后会弹出进度监控窗口
3. 窗口会实时显示预处理和特征提取的进度
4. 完成后可关闭窗口，状态会在表格中更新

### 批量数据预处理
1. 选择多个数据（使用复选框）
2. 点击"批量预处理"按钮
3. 确认后会弹出批量进度监控窗口
4. 窗口显示每个数据的详细进度
5. 可以实时查看总体进度和个别数据进度

### 状态查看
- 在数据表格的"处理状态"列查看每个数据的状态
- 状态包括图标、文字说明和进度条
- 不同状态有不同的颜色表示

## 技术实现

### 后端实现
1. **状态管理** - 在预处理过程中实时更新数据库状态
2. **进度计算** - 根据预处理和特征提取阶段计算百分比
3. **并发处理** - 支持多个数据同时处理
4. **错误处理** - 完整的错误捕获和状态更新

### 前端实现
1. **组件化设计** - 可复用的进度条和弹窗组件
2. **实时更新** - 定期轮询获取最新进度
3. **用户体验** - 直观的状态显示和操作反馈
4. **响应式设计** - 适配不同屏幕尺寸

## 部署步骤

### 1. 更新后端代码
确保所有后端文件已更新到最新版本。

### 2. 运行数据库更新
```bash
cd fastapi_backend
# 激活虚拟环境
source venv/bin/activate  # Linux/Mac
# 或
venv\Scripts\activate  # Windows

# 运行数据库更新脚本
python update_database.py
```

### 3. 重启后端服务
```bash
# 重启FastAPI服务
python main.py
```

### 4. 更新前端代码
确保前端组件已更新并重新构建：
```bash
cd frontend_ui
npm install  # 如果有新依赖
npm run build
```

### 5. 验证功能
1. 访问数据管理页面
2. 检查状态列是否正常显示
3. 测试单个和批量预处理功能
4. 验证进度窗口是否正常工作

## 注意事项

1. **数据库备份** - 运行更新脚本前建议备份数据库
2. **状态一致性** - 确保预处理过程中状态更新的一致性
3. **性能考虑** - 大量数据时进度查询可能影响性能
4. **错误恢复** - 处理失败的数据需要手动重新处理

## 故障排除

### 常见问题
1. **状态不更新** - 检查数据库连接和API调用
2. **进度窗口不显示** - 检查前端组件导入和路由
3. **数据库更新失败** - 检查数据库权限和连接配置

### 日志查看
- 后端日志：`fastapi_backend/log/`
- 数据库更新日志：`fastapi_backend/update_database.log`
- 浏览器控制台：前端错误信息

## 未来改进

1. **WebSocket支持** - 实现更实时的进度推送
2. **队列管理** - 添加任务队列管理大量预处理任务
3. **历史记录** - 保存处理历史和统计信息
4. **通知系统** - 处理完成后的邮件或推送通知 