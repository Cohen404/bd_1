# 急进高原新兵心理应激多模态神经生理监测预警系统 - FastAPI后端安装指南

## 系统要求

- **操作系统**: Windows 10/11 (64位)
- **Python版本**: 3.8+
- **内存**: 至少 8GB RAM
- **磁盘空间**: 至少 10GB 可用空间

---

## 安装步骤

### 步骤1: 安装Conda

#### 1.1 下载Miniconda

访问 [Miniconda官网](https://docs.conda.io/en/latest/miniconda.html) 下载Windows 64位安装包：

- 下载地址: https://repo.anaconda.com/miniconda/Miniconda3-latest-Windows-x86_64.exe

#### 1.2 安装Miniconda

1. 双击运行下载的安装程序
2. 点击 "Next" 继续
3. 阅读许可协议，点击 "I Agree"
4. 选择安装用户（推荐 "Just for me"）
5. 选择安装路径（默认路径即可）
6. **重要**: 勾选 "Add Miniconda3 to my PATH environment variable"
7. 点击 "Install" 开始安装
8. 安装完成后点击 "Finish"

#### 1.3 初始化Conda

安装完成后，需要初始化conda在PowerShell和CMD中的集成。打开命令提示符或PowerShell，执行以下命令：

**对于PowerShell**:
```bash
conda init powershell
```

**对于CMD**:
```bash
conda init cmd.exe
```

执行后，会显示初始化成功的提示信息。

**重要提示**:
- 初始化后需要**关闭并重新打开**命令提示符或PowerShell
- 如果使用PowerShell，可能需要设置执行策略：
  ```bash
  Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser
  ```

#### 1.4 验证安装

打开命令提示符或PowerShell，执行：

```bash
conda --version
```

如果显示版本号，说明安装成功。

---

### 步骤2: 创建虚拟环境并安装依赖

#### 2.1 创建虚拟环境

```bash
cd d:\programme\bd_1\fastapi_backend
conda create -n bd_health python=3.9 -y
```

#### 2.2 激活虚拟环境

```bash
conda activate bd_health
```

#### 2.3 升级pip

```bash
python -m pip install --upgrade pip
```

#### 2.4 安装依赖包

```bash
pip install -r requirements_windows.txt
```

**注意**: 如果安装过程中遇到编译错误，可能需要安装 Visual Studio Build Tools。

---

### 步骤3: 修改.env配置文件

#### 3.1 打开.env文件

使用文本编辑器打开 `d:\programme\bd_1\fastapi_backend\.env` 文件。

#### 3.2 修改数据库密码

找到以下配置项并修改密码：

```env
# 数据库配置
DB_HOST=127.0.0.1
DB_PORT=5432
DB_NAME=bj_health_db
DB_USER=postgres
DB_PASS=your_password_here  # 修改为您的密码
```

**重要提示**: 
- `DB_PASS` 是PostgreSQL数据库的超级用户密码
- 请使用强密码（至少8位，包含字母、数字和特殊字符）
- 记住此密码，后续安装步骤需要使用

#### 3.3 其他配置项（可选）

```env
# JWT配置
SECRET_KEY=rjD66zC6e4h58TuPFa3peppOjsUc1dprKtCIVNds4cQ
ACCESS_TOKEN_EXPIRE_MINUTES=1440

# 安全配置
BCRYPT_ROUNDS=12

# 其他配置
DEBUG=true
LOG_LEVEL=INFO
```

---

### 步骤4: 下载PostgreSQL安装程序

#### 4.1 手动下载（推荐）

访问以下链接下载PostgreSQL 14.9 Windows 64位安装程序：

- 下载地址: https://get.enterprisedb.com/postgresql/postgresql-14.9-1-windows-x64.exe

将下载的文件 `postgresql-14.9-1-windows-x64.exe` 保存到 `d:\programme\bd_1\fastapi_backend` 目录。

#### 4.2 自动下载（可选）

如果网络环境允许，安装脚本会自动下载，但建议手动下载以确保稳定性。

---

### 步骤5: 安装和配置PostgreSQL

#### 5.1 运行安装脚本

确保已激活conda虚拟环境，然后执行：

```bash
cd d:\programme\bd_1\fastapi_backend
python install_postgres_windows.py
```

#### 5.2 安装过程说明

脚本会自动执行以下操作：

1. **检查PostgreSQL是否已安装**
   - 如果已安装，跳过安装步骤

2. **安装PostgreSQL**
   - 使用静默模式安装
   - 设置超级用户密码（来自.env文件中的DB_PASS）
   - 配置服务名称为 `postgresql`
   - 设置端口为 `5432`

3. **启动PostgreSQL服务**
   - 自动启动PostgreSQL服务
   - 等待服务完全启动

4. **创建数据库和用户**
   - 创建数据库 `bj_health_db`
   - 创建用户 `postgres`
   - 授予所有权限

5. **初始化数据库表**
   - 创建所有必要的表结构

#### 5.3 验证安装

安装完成后，检查PostgreSQL服务状态：

```bash
sc query postgresql
```

如果显示 `RUNNING`，说明服务运行正常。

---

### 步骤6: 创建初始数据

#### 6.1 运行初始化脚本

```bash
python create_initial_data.py
```

#### 6.2 初始数据说明

脚本会自动创建以下数据：

**默认角色**:
- `admin` - 系统管理员
- `user` - 普通用户

**默认用户**:
- 用户名: `admin`
- 密码: `admin123`
- 邮箱: `admin@bj-health.com`
- 类型: `admin`

**默认权限**:
- `user_read` - 用户信息读取
- `user_write` - 用户信息修改
- `data_read` - 数据读取
- `data_write` - 数据修改
- `model_read` - 模型读取
- `model_write` - 模型修改
- `result_read` - 结果读取
- `result_write` - 结果修改
- `admin_all` - 系统管理

**重要提示**: 
- 首次登录后请立即修改管理员密码
- 不要在生产环境中使用默认密码

---

### 步骤7: 运行数据库迁移

#### 7.1 执行所有迁移

```bash
python -m migrations.run_all_migrations
```

#### 7.2 迁移内容说明

迁移脚本会按顺序执行以下操作：

1. **添加 has_result 字段到 tb_data 表**
   - 标记数据是否有评估结果

2. **添加 personnel_id, personnel_name, active_learned 字段到 tb_result 表**
   - 人员ID和姓名
   - 是否进行过主动学习

3. **更新已有结果记录的人员信息**
   - 为已有结果填充人员信息

4. **添加 active_learned 字段到 tb_data 表**
   - 标记数据是否进行过主动学习

5. **添加 overall_risk_level 字段到 tb_result 表**
   - 总体风险等级（低风险/中等风险/高风险）

6. **更新已有结果记录的总体风险等级**
   - 计算并更新风险等级

7. **初始化系统参数的默认值**
   - 创建11条系统参数

#### 7.3 验证迁移

迁移完成后，会显示执行结果：

```
总计: 7 个迁移
成功: 7 个
失败: 0 个

✓ 所有迁移执行成功！
```

---

## 启动服务

### 启动FastAPI后端服务

```bash
uvicorn main:app --reload
```

服务启动后，访问以下地址：

- **API文档**: http://127.0.0.1:8000/docs
- **ReDoc文档**: http://127.0.0.1:8000/redoc
- **健康检查**: http://127.0.0.1:8000/health

---

## 常见问题

### 问题1: conda命令未找到

**解决方案**: 
- 重新安装Miniconda，确保勾选 "Add to PATH"
- 或手动添加Miniconda到系统环境变量

### 问题2: pip安装依赖失败

**解决方案**:
```bash
# 使用国内镜像源
pip install -r requirements_windows.txt -i https://pypi.tuna.tsinghua.edu.cn/simple
```

### 问题3: PostgreSQL安装失败

**解决方案**:
- 检查是否有足够的磁盘空间
- 关闭杀毒软件
- 以管理员身份运行命令提示符
- 手动下载安装程序并运行

### 问题4: 数据库连接失败

**解决方案**:
- 确认PostgreSQL服务正在运行
- 检查.env文件中的密码是否正确
- 验证数据库和用户是否创建成功

### 问题5: 端口被占用

**解决方案**:
```bash
# 查看端口占用
netstat -ano | findstr :5432

# 如果被占用，可以修改.env中的DB_PORT
```

---

## 卸载说明

### 卸载PostgreSQL

1. 停止PostgreSQL服务:
```bash
net stop postgresql
```

2. 使用Windows控制面板卸载PostgreSQL

3. 删除数据目录（如果需要）:
```
C:\Program Files\PostgreSQL\14\data
```

### 删除虚拟环境

```bash
conda deactivate
conda remove -n bd_health --all
```

---

## 技术支持

如遇到问题，请检查：

1. **日志文件**: 查看应用日志了解详细错误信息
2. **PostgreSQL日志**: `C:\Program Files\PostgreSQL\14\data\log`
3. **环境变量**: 确认所有必要的环境变量已正确设置

---

## 版本信息

- **系统版本**: 1.0.0
- **PostgreSQL版本**: 14.9
- **Python版本**: 3.9+
- **更新日期**: 2024-01-28

---

## 附录: 完整安装命令汇总

```bash
# 1. 初始化Conda（首次安装后执行一次）
conda init powershell
conda init cmd.exe

# 2. 关闭并重新打开命令提示符或PowerShell

# 3. 激活虚拟环境
conda activate bd_health

# 4. 进入项目目录
cd d:\programme\bd_1\fastapi_backend

# 5. 安装依赖
pip install -r requirements_windows.txt

# 6. 修改.env文件中的密码（使用文本编辑器）

# 7. 下载PostgreSQL安装程序到当前目录
# 下载地址: https://get.enterprisedb.com/postgresql/postgresql-14.9-1-windows-x64.exe

# 8. 安装PostgreSQL
python install_postgres_windows.py

# 9. 创建初始数据
python create_initial_data.py

# 10. 运行数据库迁移
python -m migrations.run_all_migrations

# 9. 启动服务
python main.py
```

---

**注意**: 本安装指南适用于Windows系统。如需在Linux或macOS上安装，请参考相应的安装文档。
