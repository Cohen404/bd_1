我希望用户管理数据库表字段设计成这样：
表：tb_user
字段名	数据类型	长度	是否允许空值	默认值	备注
user_id	varchar	64	否		用户ID，主键
username	varchar	50	否		用户名
password	varchar	64	否		用户密码（加密存储）
email	varchar	100	否		用户邮箱
phone	varchar	20	是	NULL	用户电话号码
full_name	varchar	255	是	NULL	用户全名
user_type	varchar	10	否	'user'	用户类型 ('admin' 或 'user')
last_login	datetime		是	NULL	上次登录时间
created_at	datetime		否	CURRENT_TIMESTAMP	用户创建时间
updated_at	datetime		是	CURRENT_TIMESTAMP	用户信息更新时间

对应的用户相关的接口功能和展示都要有改动。
并且修改对应的readme文档。
数据库初始化插入的数据仍然要保留，增加的字段就给一些默认的测试值就行了。
说中文

界面功能不要有太多变化。只改动和这个表相关的功能就行。并且一定要保证不出错，仔细检查。
最后自动帮我进行表的初始化。

tb_user的初始化sql也要有对应的修改。

postgresql 用户名postgres，密码postgres，端口5432和ip 127.0.0.1










(301) PS D:\work\东华\项目\2023\301\changhang\start\bj_health_manage\rear> python .\init_login.py
2024-11-26 15:03:24.865912: I tensorflow/core/util/port.cc:153] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2024-11-26 15:03:26.011209: I tensorflow/core/util/port.cc:153] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
QLayout: Attempting to add QLayout "" to QWidget "centralwidget", which already has a layout
QLayout: Attempting to add QLayout "" to QWidget "centralwidget", which already has a layout
Traceback (most recent call last):
  File "D:\work\东华\项目\2023\301\changhang\start\bj_health_manage\rear\..\rear\admin_rear.py", line 112, in open_health_evaluate
    self.health_evaluate = health_evaluate_rear.Health_Evaluate_WindowActions()
  File "D:\work\东华\项目\2023\301\changhang\start\bj_health_manage\rear\..\rear\health_evaluate_rear.py", line 62, in __init__
    self.user_type = self.get_user_type(self.user_id)
  File "D:\work\东华\项目\2023\301\changhang\start\bj_health_manage\rear\..\rear\health_evaluate_rear.py", line 113, in get_user_type
    user = session.query(User).filter(User.id == user_id).first()
AttributeError: type object 'User' has no attribute 'id'

现在登录正确了。但是与tb_user相关的功能都需要重新查看，因为你现在修改了tb_user的表结构了。
你已经修改了tb_user的数据库表结构了，看看其他使用了这张表的部分是否要做对应的修改。



点击结果查看，提示错误：
(301) PS D:\work\东华\项目\2023\301\changhang\start\bj_health_manage\rear> python .\init_login.py
2024-11-26 16:23:11.620584: I tensorflow/core/util/port.cc:153] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2024-11-26 16:23:15.126824: I tensorflow/core/util/port.cc:153] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
QLayout: Attempting to add QLayout "" to QWidget "centralwidget", which already has a layout
QLayout: Attempting to add QLayout "" to QWidget "centralwidget", which already has a layout
QLayout: Attempting to add QLayout "" to QWidget "centralwidget", which already has a layout
QLayout: Attempting to add QLayout "" to QWidget "centralwidget", which already has a layout
Traceback (most recent call last):
  File "D:\work\东华\项目\2023\301\changhang\start\bj_health_manage\rear\..\rear\admin_rear.py", line 139, in open_results_view
    self.results_view = results_view_rear.Results_View_WindowActions()
  File "D:\work\东华\项目\2023\301\changhang\start\bj_health_manage\rear\..\rear\results_view_rear.py", line 60, in __init__
    self.user_type = self.get_user_type(self.user_id)
  File "D:\work\东华\项目\2023\301\changhang\start\bj_health_manage\rear\..\rear\results_view_rear.py", line 83, in get_user_type
    user = session.query(User).filter(User.id == user_id).first()
AttributeError: type object 'User' has no attribute 'id'








现在点击结果查看出现错误：
(301) PS D:\work\东华\项目\2023\301\changhang\start\bj_health_manage\rear> python .\init_login.py
>>
2024-11-26 16:29:30.190346: I tensorflow/core/util/port.cc:153] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2024-11-26 16:29:31.385536: I tensorflow/core/util/port.cc:153] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
QLayout: Attempting to add QLayout "" to QWidget "centralwidget", which already has a layout
QLayout: Attempting to add QLayout "" to QWidget "centralwidget", which already has a layout
QLayout: Attempting to add QLayout "" to QWidget "centralwidget", which already has a layout
QLayout: Attempting to add QLayout "" to QWidget "centralwidget", which already has a layout
Traceback (most recent call last):
  File "D:\work\东华\项目\2023\301\changhang\start\bj_health_manage\rear\..\rear\admin_rear.py", line 139, in open_results_view
    self.results_view = results_view_rear.Results_View_WindowActions()
  File "D:\work\东华\项目\2023\301\changhang\start\bj_health_manage\rear\..\rear\results_view_rear.py", line 78, in __init__
    self.btn_delete.clicked.connect(self.delete_result)  # 删除结果
AttributeError: 'Results_View_WindowActions' object has no attribute 'btn_delete'









点击结果查看，提示显示表格失败: foreign key associated with colum ' tb_result.user_id' could not find table 'tb_user' with which to generatea foreighn key to target column 'user_id'







去除结果查看中的删除结果按钮，现在结果不允许删除。




在数据查看页面，我登录的用户id是admin001，但是并没有看到表格中admin001所上传的数据。
还是没有看到对应用户所上传的数据。








用户登陆时，登录的session保存在'../state/user_status.txt'中。这个有没有适应新的tb_user表结构？并且保存的user_id是否正确？我现在登录admin用户（user_id=admin001)还是看不到上传的数据。




数据查看页面还是没有找到正确的登录用户id，并显示已上传的数据。并且如果是管理员用户登录的话我希望能够看到所有结果和数据。data_view_rear.py中读取'../state/user_status.txt'获得当前登录用户id可能有问题，当前登录用户id保存在current_user.txt中



点击修改密码页面，提示错误：
Traceback (most recent call last):
  File "D:\work\东华\项目\2023\301\changhang\start\bj_health_manage\rear\..\rear\admin_rear.py", line 157, in open_change_pwd_view
    self.change_pwd = change_pwd_controller.change_pwd_Controller()
  File "D:\work\东华\项目\2023\301\changhang\start\bj_health_manage\rear\..\rear\change_pwd_controller.py", line 32, in __init__
    self.setupUi(self)
AttributeError: 'change_pwd_Controller' object has no attribute 'setupUi'





修改密码页面现在是全空白的。我希望你在这个页面实现修改密码的功能。










现在每一个页面展示好像是销毁原有页面，然后再重建页面的。这样可能有问题。因为我比如在主页最大化了之后再进入新的一个页面之后，会变回窗口化。所以我希望你优化这一点，优化页面跳转的逻辑。




没有变化。现在页面跳转的时候还是会从最大换变回窗口化











禁止所有页面最大化



我希望登录页面也不要有最大化按钮。包括登陆页面中输入用户名也密码的页面，不要有最大化按钮，禁止窗口最大化。



模型管理、日志管理和密码修改页面的最大化按钮还是可用的。












我希望模型输出结果中有输出各个应激类型的概率（应激、抑郁、焦虑）分数在0-100之间，从模型预测结果中得到。并展示在健康评估界面上。




应激评估页面查看不到已上传数据。其中管理员可以查看所有数据，非管理员只能查看自己上传的数据。上传数据的用户id是tb_data的user_id



现在我用admin001用户登录（user_id=admin001，并且是管理员），还是看不到任何数据。





查看模型结果中的各个应激类型的概率（应激、抑郁、焦虑）分数在0-100之间，不要百分号。并且分数为出来结果列表中1的数量的占比*100。


模型结果中各应激类型的概率是num*100,num是 num = (y_pred.argmax(axis=-1).sum())/len(y_pred)，tuili.py中的



我希望登录页面，密码框输入回车，就等于点击登录按钮。现在没有这个操作绑定。






我希望在数据查看页面，每次上传数据之后，数据那一栏有一个预处理按钮。可以进行数据的预处理（                        data_pretreatment.treat(data_path)
）
以及进行数据特征的处理和保存（
                            try:
                                data_out.analyze_eeg_data(file_path)
                                logging.info(f"Visualization completed for file: {file_path}")
                                QMessageBox.information(self, "信息", "可视化成功完成")
                            except Exception as e:
                                logging.error(f"Error during visualization: {str(e)}")
                                QMessageBox.warning(self, "警告", f"可视化过程中出现错误: {str(e)}")

）

这两个过程要一起进行，通过这一个按钮来控制。










数据预处理和特征提取按钮点击之后前端会等待未响应，并且跳出这个框。要等到处理完成了系统才能用。我希望不要卡死，并且可以出来一个进度条提示用户等待。







我希望上传时不要输入用户名，user_id以及各种信息就绑定当前登录用户的信息。
并且上传之后的数据目录复制到data目录中去，数据库中保存的路径也要记录data目录中所记录的路径
并且界面上展示目录路径的时候只展示最后一个目录的名称，前面的完整路径不需要，也就是展示在data目录里的名称。




显示路径里，要显示最后一个\或者/之后的字符串。并且数据路径在显示的时候要完整显示，表格里给的宽度要足够






结果查看页面点击返回后也会直接退出程序。我希望你帮我再看看其他页面有没有同样的问题





现在所有页面点击返回按钮之后系统会直接退出，我希望你解决这个问题，不要出现点击返回闪退的情况。像是在主页点击能够进入的页面，点击返回之后应该进入主页。














评估页面看不到已经上传的数据。如果是管理员的话能看到所有数据，如果是普通用户只能看到自己上传的数据。数据路径显示要显示最后一个\或者/之后的字符串。并且数据路径在显示的时候要完整显示，表格里给的宽度要足够









这个预处理逻辑只考虑了edf数据（未进行预处理），有可能传入的数据已经与处理了（保存成fif.fif），如果没有未预处理的数据，只有已经预处理的数据则直接跳过预处理过程就行，将fif数据保存到fif.fif就行





用户管理界面中不应该显示用户密码，并且用户角色没有显示到对应的位置，操作下面也不是正确的内容。邮箱要可以为空的。修改用户信息界面里，需要弹出个框进行修改。创建用户的界面也需要根据数据库里的内容进行增加。



我需要数据库中重建这张表，帮我修改sql_model.sql以及tb_user.py，并且告诉我用什么命令可以重建这张表，并且进行这张表的初始化。






结果查看页面，下面的表中普通应激、抑郁、焦虑应为数据库里的原值。并且右边需要有一个查看按钮，点击后右上角可以看到特征图，这个特征图展示的逻辑和应激评估页面（health_evaluate_rear.py)里的一致。左上角当前评估结果显示三个状态，>=50圆形变成红色，否则就是灰色。当下面表中结果太多了的时候可以通过上下滑动查看。






结果查看中点击表格中的查看，应该左上角的结果显示评估状态：左上角当前评估结果显示三个状态，对应result1-3，>=50圆形变成红色，否则就是灰色。右上角的图片展示默认展示Theta特征图像，图像上面显示标题，可以参考应激评估页面（health_evaluate_rear.py）中的展示方式。


右上角的特征图像不要通过下拉菜单选择，要点击prev和next进行切换，上方显示图片标题。



结果查看页面中，点击了表格中的查看之后，左上角评估状态不仅要变颜色，也要显示result1-3的分数，放到文字后面，括号里。



结果查看页面中，点击了表格中的查看之后，右上角的文字要是特征的名称，要随着prev和next按钮有变化。









用户的密码要进行sha256的加密，注意登录、用户注册、用户修改密码的时候都需要进行加密，登陆时需要加密后验证。

sql初始化时插入的密码也进行sha256加密



数据查看页面，缩小上传按钮，并且增加一个批量上传按钮，批量上传按钮可以把一个目录下所有子目录都循环使用上传功能进行上传。上面是上传按钮，下面是批量上传按钮。



点击批量上传并没有上传成功，我希望实现的是，点击批量上传选择了/path/之后，把/path/下的所有/path/a,/path/目录（a,b必须要是目录）都调用上传功能进行依次上传。




我批量上传了5个数据了之后，数据查看页面里的表格中只会出来一个最新的数据。4个数据在数据库里已经插入了，但是并没有显示在表格中。根据用户权限显示记录。管理员可以看到所有数据，普通用户只能看到当前用户所上传的数据，这个逻辑再现有代码里应该已经有了。并且新上传的所有数据必须显示在表格中。




你看一下这里，我点击了批量上传了，上传了/tmp/目录下的5个目录的数据，但是表格中只能看到一个。







数据上传（不是批量上传）功能是否能够开放一个http的post接口服务，让外部服务可以通过接口上传数据？外部服务上传一个zip文件（二进制文件），参数还有用户id(user_id)，然后系统下载到tmp目录中，解压缩后放到data目录中，接下来的流程就和上传一样了，如果有重名的就加后缀重命名。然后在数据库里记录一下。







在health_evaluate_rear中，在533-534行
        probability_score = float(num) * 100  # 将num*100改为num*95，使得最大值为95
        probability_score = max(0, min(95, probability_score))  # 确保分数在0-95之间
后，得到了数据之后我希望有多模态数据融合处理的逻辑，对分数进行改动
首先，检查是否有量表数据存在(lb.csv)，如果有的话使用pandas读取lb.csv(第一行为title，第二行为数据，逗号分隔）
把前20列的数据加在一起得到数值x, 得到分数1 score_lb_1=(x-48)/80*3
把后20列的数据加在一起得到数值x, 得到分数2 score_lb_2=(x-53)/80*3

然后检查是否有血清学数据（xq.csv），如果有的话使用pandas读取xq.csv(第一行为title，第二行为数据，逗号分隔）
把所有列的值（去除"<",">","≤","≥"，转float）求和，结果/5000得到分数3（score_xq）

针对普通应激分数，最终分数为probability_score+score_xq
针对抑郁分数，最终分数为probability_score+score_lb_1
针对焦虑分数，最终分数为probability_score+score_lb_2





在根目录新建一个python文件，能够代替
cd rear
python init_login.py





点击应激评估，针对数据如果找不到，或者格式错误的时候会提示：
['2024-12-04 16:15:06']
Traceback (most recent call last):
  File "D:\work\东华\项目\2023\301\changhang\start\bj_health_manage\rear\..\model\tuili.py", line 113, in run
    result = self.predict()
  File "D:\work\东华\项目\2023\301\changhang\start\bj_health_manage\rear\..\model\tuili.py", line 102, in predict
    X_test = self.get_data()
  File "D:\work\东华\项目\2023\301\changhang\start\bj_health_manage\rear\..\model\tuili.py", line 80, in get_data
    data = exp_data[-(num_of_data)::, ::, ::]
UnboundLocalError: local variable 'exp_data' referenced before assignment






我现在希望评估结果之后，在应激评估页面增加一个生成报告按钮（每行数据有一个），点击按钮之后生成docx的报告。生成逻辑如下：
# 1. 读取模板文件template.docx文件
其中模板文件的内容如下：
应激评估报告
1.用户基本信息
用户名：[user.username]
邮箱：[user.email]
手机：[user.phone]
用户创建时间：[user.created_at]

2.应激评估信息
普通应激评分：[normal_yingji.score], 评估结果：[normal_yingji.result]
抑郁评分：[depression.score], 评估结果：[depression.result]
焦虑评分：[stress.score], 评估结果：[stress.result]

3.评估数据可视化
3.1 脑电信号
[signals.eeg]
3.2 血清数据
[signals.blood]
3.3 量表数据
[signals.scale]
4.防护建议
[suggest]

# 2. 对模板中的内容进行替换：
[user.username] 替换数据上传用户的用户名
[user.email] 替换数据上传用户的邮箱
[user.phone] 替换数据上传用户的手机号
[user.created_at] 替换数据上传用户的用户创建时间

[normal_yingji.score] 替换对应评估结果中的普通应激评分result1
[normal_yingji.result] 在result1>=50的时候为"可能存在应激情况"，否则为"低概率存在应激情况"
[depression.score] 替换对应评估结果中的普通应激评分result2
[normal_yingji.result] 在result1>=50的时候为"可能存在抑郁情况"，否则为"低概率存在抑郁情况"
[stress.score] 替换对应评估结果中的普通应激评分result3
[normal_yingji.result] 在result1>=50的时候为"可能存在焦虑情况"，否则为"低概率存在焦虑情况"

生成的报告保存在data/results目录中，用result id命名




在生成的报告的[signals.eeg]替换图，图文件对应：
            self.image_list = [
                "Theta.png", "Alpha.png", "Beta.png", "Gamma.png",
                "frequency_band_1.png", "frequency_band_2.png", "frequency_band_3.png", "frequency_band_4.png", "frequency_band_5.png",
                "time_过零率.png", "time_方差.png", "time_能量.png", "time_差分.png",
                "frequency_wavelet.png", "differential_entropy.png"
            ]

每个图的名称对应：
            image_names = [
                "Theta波段功率", "Alpha波段功率", "Beta波段功率", "Gamma波段功率",
                "均分频带1", "均分频带2", "均分频带3", "均分频带4", "均分频带5",
                "域特征 - 过零率", "时域特征 - 方差", "时域特征 - 能量", "时域特征 - 差分",
                "时频域特征 - 小波变换", "微分熵"
            ]
名称+：要显示在图的上一行。











tb_result结果表中，result1改成stress_score，类型为float，代表普通应激分数；result2改为depression_score，类型为float，代表抑郁分数；result3改为anxiety_score，类型为float，代表焦虑分数；另外增加report_path，备注为报告路径，存储生成报告的路径。

在应激评估页面中，要求必须有应激结果并且有3个分数的情况下才能够生成应激报告，否则弹出提示。生成了docx报告之后，自动将docx报告转换成pdf，文件名相同。docx和pdf的报告文件名都要是result_id。report_path存储pdf文件路径。原本生成报告中template内容填充的代码不要有任何删除（health_evaluate_rear.py line 771 - line 896） generateReport函数


在结果展示中，最右侧增加查看报告按钮，点击打开一个页面，可以查看生成的pdf文件，并且有一个下载按钮，弹出框允许用户把pdf报告保存到指定目录中。按钮要增加到原本查看按钮的右边（rear\results_view_rear.py, line 287)







result_view_rear.py中新增加的buttonForRow的查看功能，并在line 286-line 302行已经定义过了，新的"查看报告"按钮在这里定义就行了，不要重新再构建一个buttonForRow函数。或者把一行中所有的button都放到这个函数里，并且查看按钮在301行调用了self.view_details函数，这个功能不能缺少，最好要保持原状。



result_view_rear.py中的result1-3都在数据库表的列都变成了stress_score,depression_score,anxiety_score



能否在result_view_rear.py页面中点击row的查看报告的时候，将pdf报告转换成图像然后展示在弹出的窗口中展示图像（可放大缩小），点击弹出窗口下方的下载报告按钮，将pdf报告下载到指定目录中。







点击"报告按钮"生成报告的时候，显示进度条，完成后不要提示具体报告保存路径，提示：报告生成完毕，可以在结果管理中查看。






sql_model.sql中增加这几张表，不过不要有功能
(2)tb_role（角色信息表）
字段名	数据类型	长度	是否允许空值	默认值	备注
role_id	varchar	64	否		角色ID，主键
role_name	varchar	50	否		角色名称
description	varchar	255	是	NULL	角色描述
created_at	datetime		否	CURRENT_TIMESTAMP	角色创建时间


(3)tb_user_role（用户角色关联表）
字段名	数据类型	长度	是否允许空值	默认值	备注
user_id	varchar	64	否		用户ID
role_id	varchar	64	否		角色ID



(1)tb_permission（权限表）
字段名	数据类型	长度	是否允许空值	默认值	备注
permission_id	varchar	64	否		权限ID，主键
permission_name	varchar	100	否		权限名称
page_url	varchar	255	否		访问的页面URL
description	varchar	255	是	NULL	权限描述
created_at	datetime		否	CURRENT_TIMESTAMP	权限创建时间


tb_role_permission（角色权限关联表）
字段名	数据类型	长度	是否允许空值	默认值	备注
role_id	varchar	64	否		角色ID
permission_id	varchar	64	否		权限ID


(1)tb_system_params（系统参数表）
字段名	数据类型	长度	是否允许空值	默认值	备注
param_id	varchar	64	否		参数ID，主键
eeg_frequency	float		是	NULL	脑电数据采样频率 (Hz)
electrode_count	int	11	是	NULL	电极数量
scale_question_num	int	11	是	NULL	量表问题数量
model_num	int	11	是	NULL	系统中可用的模型数量






结果查看页面需要增加一个按钮，能够导出所有结果（表格中的内容）到excel，前端页面为result_view.py










现在每一次页面打开的位置都是默认位置，如果旧页面是移动了一个位置，打开了新页面之后，那么新页面一定会在默认位置打开，这样会导致我永远无法移动软件的窗口位置。我现在希望所有旧页面在打开新的页面的时候，新页面都放到旧页面所在的位置。不要修改其他任何功能。



你需要查看backend中的所有python文件，_backend结尾的python文件，看一下是否所有的窗口都继承了WindowManage类，如果没有继承的话，直接修改原代码中的文件位置配置。






生成报告时，针对应激、抑郁、焦虑三个状态情况（是否大于等于50%）来生成防护建议，并替换模板中的[suggest]
如果有应激可能（大于等于50%），则防护建议中增加：
templates/stress.txt中的内容

如果有抑郁可能（大于等于50%），则防护建议中增加：
templates/depression.txt中的内容

如果有焦虑可能（大于等于50%），则防护建议中增加：
templates/anxiety.txt中的内容

如果官兵应激、抑郁、焦虑的分数都比较低（<50）则防护建议内容为：
templates/normal.txt中的内容

















我找到问题了，
首先针对read_raw_eeglab读取的情况：
先尝试默认参数读取，如果raw = read_raw_eeglab(set_path, preload=False)出错的话，尝试加入参数uint16_codec='ascii'参数。这是eeglab编码问题导致的

如果还是有问题，那应该 说明SET文件包含epochs数据，改用epochs读取方式
先尝试epochs = mne.io.read_epochs_eeglab(set_path)
如果出错尝试增加uint16_codec='ascii'参数








我希望用户管理界面里面有一个角色管理功能（放到用户管理页面中），跳转到角色管理页面，可以进行角色可访问的权限管理，默认角色就两个（管理员和普通用户）。

我希望这个角色管理页面里面对每个角色权限的控制就是登录之后能看到哪几个页面的跳转按钮。

管理员就是默认可以使用全部功能（也就是在管理员登录页面中所展示的所有功能按钮和跳转），而用户只能使用4个功能（参考用户现在的登陆界面的功能按钮和跳转）。而且数据库表应该已经建立了，你要参考init_db.py中数据库初始化脚本，有必要可以修改初始化脚本中与角色、权限相关的表

# 注意：
* 界面都是要是中文的
* 前端都放到frontend目录中，结尾是_UI.py
* 后端功能都放到backend目录中，结尾是_backend.py








三个问题
1.角色权限管理界面的按钮不能是role management，要是中文才行
2.初始化的角色权限中，管理员能够访问应激评估、结果管理、数据管理、模型管理、用户管理、系统参数、日志管理、密码修改这8个页面（注意，这个是QT的单击窗口化软件），而普通用户只能访问（应激评估、结果管理、数据管理和密码修改这4个页面）。2个角色的权限初始化要严格按照每个角色可访问的页面来初始化配置。
3. 角色权限管理界面的按钮打开，没有任何反应，并没有打开角色权限管理界面。







所有用户在数据库中也要采用角色表中的角色关系，对于是否是管理员的判断在所有页面中也要更改（在应激评估、数据管理、结果管理中有区分是否是管理员还是普通用户的逻辑）。用户属于哪个角色在tb_user表中的user_type中定义role_id，并且管理员role id要是admin， 普通用户role id要是user。数据库的初始化也要修改

# 注意
× 不要修改其他任何功能，之修改我让你修改的功能
× 所有代码不要有太大的变动，所有代码的逻辑、框架、类继承以及撰写风格必须按照原有代码的来，不要随意创造。
× 管理员role id要是admin， 普通用户role id要是user，必须遵守






我希望不同用户在登录主页的时候（普通用户或者管理员用户），根据权限所配置的功能（8个之中的几个）来自动化配置登录主页界面的跳转功能按钮，并且根据功能的数量自适应功能界面跳转按钮的排版。

每次都是2行，平均分布。

普通用户登录页面（index_UI.py）和管理员用户登录界面(admin_index_UI.py)都需要自适应，并且根据权限（在角色管理页面中设置role_manage_UI.py和role_manage_backend.py）来选择和排版跳转功能的按钮

# 注意
× 不要修改其他任何功能，之修改我让你修改的功能
× 所有代码不要有太大的变动，所有代码的逻辑、框架、类继承以及撰写风格必须按照原有代码的来，不要随意创造。
× 管理员role id要是admin， 普通用户role id要是user，必须遵守





普通用户主页页面（index_UI.py，后端是index_backend.py）和管理员用户主页界面(admin_index_UI.py, 后端是admin_index_backend.py)
你修改错了，要修改的是这两个界面，根据角色所赋予的权限，展示对应的功能按钮。

# 注意
* 不要修改其他任何功能，之修改我让你修改的功能
* 所有代码不要有太大的变动，所有代码的逻辑、框架、类继承以及撰写风格必须按照原有代码的来，不要随意创造。
* 管理员role id要是admin， 普通用户role id要是user，必须遵守
* 必须根据用户角色在数据库中所赋予的权限（数据库中查询）来选择在主页展示哪个功能跳转按钮
* 必须根据权限动态选择跳转功能进行展示，所以必须要查询数据库






角色管理界面中，下面选项中，不要有角色管理，因为角色管理是放在用户管理功能里的。而且第一行管理员的编辑权限按钮，点击下面没有反应，要点第二行普通用户的编辑权限按钮才可以显示，你看看是什么情况。


# 注意
* 不要修改其他任何功能，之修改我让你修改的功能
* 所有代码不要有太大的变动，所有代码的逻辑、框架、类继承以及撰写风格必须按照原有代码的来，不要随意创造。




数据分析这个权限错误了，应该是修改密码，在数据库初始化脚本，以及角色管理界面上都改一下。以及普通用户和管理员用户的主页界面中权限判断中都改一下，要绑定修改密码的按钮和跳转

# 注意
* 不要修改其他任何功能，之修改我让你修改的功能
* 所有代码不要有太大的变动，所有代码的逻辑、框架、类继承以及撰写风格必须按照原有代码的来，不要随意创造。







接下来我希望增加系统备份和恢复功能（放到系统参数页面）
可以备份和恢复的内容包括：数据库、数据存储（文件系统路径中的数据 data目录）、模型文件（文件系统路径中的模型文件 model目录）、结果生成的报告（data/results目录）

备份的文件路径放到 .backup中
备份的数据库文件也放到这个目录中，存储为合适的文件，方便恢复

# 注意
* 不要修改其他任何功能，之修改我让你修改的功能
* 所有代码不要有太大的不必要变动，所有代码的逻辑、框架、类继承以及撰写风格必须按照原有代码的来，不要随意创造。
* 界面上所有内容使用中文
* 原有代码中已有的功能，与本次修改功能无关，或者不冲突的，一律不准有任何修改。







有两个问题需要解决
1. 在备份和还原的时候，点击了备份/还原按钮之后要等几秒之后进度条才出现，我希望点击了之后立刻进度条就出现了
2. 还原了之后直接退出登录，返回到登录界面







我希望数据管理页面可以选择上传的数据进行批量预处理（多进程，如果子进程运行的时候主进程关闭了，则子进程也全部停止删除了。
可选择的数据最多200个，显示已选择的数据数量。
多进程数量为当前CPU数量-2
看看还有什么方法可以更加的提升批量数据预处理的速度的，也给我一些优化建议，因为我这个程序需要达到在1分钟之内完成200条数据的预处理。

数据预处理代码的优化要正确，与原本的预处理结果完全一样，你可以优化效率，但是效率提升的前提是预处理的结果是和现在一样的。

# 注意
* 不要修改其他任何功能，之修改我让你修改的功能
* 所有代码不要有太大的不必要变动，所有代码的逻辑、框架、类继承以及撰写风格必须按照原有代码的来，不要随意创造。
* 界面上所有内容使用中文
* 原有代码中已有的功能，与本次修改功能无关，或者不冲突的，一律不准有任何修改。
* 预处理的结果必须与现在脚本中的完全一样，不要因为效率导致了错误
* 所有的try except必须输出完整错误栈




批量上传按钮上移，批量预处理按钮放到原本批量上传按钮的地方，并且外形风格一致。然后需要一个选择数据的功能，还要有选择前200个的按钮，在数据浏览表格的上面。注意，数据最做只能选200个，超过了则其他的选择框变成灰色，不可选择。








现在数据预处理的时候有错误：
Overwriting existing file.
Loading data for 1 events and 1000 original time points ...
Overwriting existing file.
Loading data for 298 events and 1000 original time points ...
处理数据 2 时出错: cannot reshape array of size 0 into shape (59,1000)


请在数据预处理脚本中的所有try except中输出错误栈，方便我寻找错误
并且对比一下之前的数据预处理脚本，看看错误如何解决，注意预处理的结果必须要和之前是完全一样的，在保证预处理正确的前提下提升预处理的速度

# 注意
* 不要修改其他任何功能，之修改我让你修改的功能
* 所有代码不要有太大的不必要变动，所有代码的逻辑、框架、类继承以及撰写风格必须按照原有代码的来，不要随意创造。
* 界面上所有内容使用中文
* 原有代码中已有的功能，与本次修改功能无关，或者不冲突的，一律不准有任何修改。




有几个问题需要修改：
1.点击批量预处理之后要立刻弹出进度条。
2.如果检测到fif文件，那么不需要预处理，也等于完成了一个预处理，进度要增加
3.进度条里面要有一个计时

# 注意
* 不要修改其他任何功能，之修改我让你修改的功能
* 所有代码不要有太大的不必要变动，所有代码的逻辑、框架、类继承以及撰写风格必须按照原有代码的来，不要随意创造。
* 界面上所有内容使用中文
* 原有代码中已有的功能，与本次修改功能无关，或者不冲突的，一律不准有任何修改。
* 预处理的结果必须与现在脚本中的完全一样，不要因为效率导致了错误
* 所有的try except必须输出完整错误栈






我希望在应激评估中，只调用普通应激的模型，并且在系统打开的时候就预先载入了，其他两个应激（焦虑和抑郁）都是使用普通应激的结果，完全相等。

应激结果展示、存储、模型状态检测等逻辑不要有任何的修改呀。
而且模型实例要在系统打开的时候就预先创建（打开Index_WindowActions()的时候），放到gpu里，而不是在窗口打开的时候才创建。

# 注意
* 不要修改其他任何功能，之修改我让你修改的功能
* 所有代码不要有太大的不必要变动，所有代码的逻辑、框架、类继承以及撰写风格必须按照原有代码的来，不要随意创造。
* 界面上所有内容使用中文
* 原有代码中已有的功能，与本次修改功能无关，或者不冲突的，一律不准有任何修改。
* 预处理的结果必须与现在脚本中的完全一样，不要因为效率导致了错误
* 所有的try except必须输出完整错误栈


注意，模型载入要修改tuili.py中的predict，把模型载入和模型预测这两个过程分离开来。系统刚打开的时候只调用load_model，在应激评估页面点击评估按钮的时候再使用已经载入的模型进行predict




和我想要的不一样
1. tuili.py中模型加载要直接一个静态的函数来进行，给一个静态变量赋值，在评估的时候直接可以用这个模型变量
2. init_login的时候，模型预加载所载入的模型要是数据库里取出来的model_type=0的普通应激模型，取数据库里对应的路径。
3. 应激评估页面中，评估功能的抑郁和焦虑结果要直接使用普通应激模型的结果，也就是说现在只有一个模型就可以了
模型加载的方式，和tuili.py中原有模型加载的方式代码完全一样

# 注意
* 不要修改其他任何功能，之修改我让你修改的功能
* 所有代码不要有太大的不必要变动，所有代码的逻辑、框架、类继承以及撰写风格必须按照原有代码的来，不要随意创造。
* 界面上所有内容使用中文
* 原有代码中已有的功能，与本次修改功能无关，或者不冲突的，一律不准有任何修改。
* 预处理的结果必须与现在脚本中的完全一样，不要因为效率导致了错误
* 所有的try except必须输出完整错误栈
* 数据库连接信息在util/db_util.py, 数据结构在sql_model/目录中可以看到，数据库初始化脚本在init_db.py中






我希望应激评估在单条数据评估的时候，点击评估按钮可以立刻弹出一个进度条，显示推理进度。你所需要修改的代码应该很少就可以实现这个功能。
不要影响到模型初始化的代码，不要影响到应激评估页面的数据获取的代码，也不要影响到其他任何的代码。

# 注意
* 不要修改其他任何功能，之修改我让你修改的功能
* 所有代码不要有太大的不必要变动，所有代码的逻辑、框架、类继承以及撰写风格必须按照原有代码的来，不要随意创造。
* 界面上所有内容使用中文
* 原有代码中已有的功能，与本次修改功能无关，或者不冲突的，一律不准有任何修改。
* 预处理的结果必须与现在脚本中的完全一样，不要因为效率导致了错误
* 所有的try except必须输出完整错误栈
* 数据库连接信息在util/db_util.py, 数据结构在sql_model/目录中可以看到，数据库初始化脚本在init_db.py中





我希望你单独创建一个脚本，帮我把model_type=0的模型进行int8量化，然后把原有的载入和推理变成量化模型的载入和推理

# 注意
* 不要修改其他任何功能，之修改我让你修改的功能
* 所有代码不要有太大的不必要变动，所有代码的逻辑、框架、类继承以及撰写风格必须按照原有代码的来，不要随意创造。
* 界面上所有内容使用中文
* 原有代码中已有的功能，与本次修改功能无关，或者不冲突的，一律不准有任何修改。
* 预处理的结果必须与现在脚本中的完全一样，不要因为效率导致了错误
* 所有的try except必须输出完整错误栈
* 数据库连接信息在util/db_util.py, 数据结构在sql_model/目录中可以看到，数据库初始化脚本在init_db.py中






好的，那么我希望你接下来修改模型载入和模型推理的代码，适应现在INT8推理的模型。

# 注意
* 不要修改其他任何功能，之修改我让你修改的功能
* 所有代码不要有太大的不必要变动，所有代码的逻辑、框架、类继承以及撰写风格必须按照原有代码的来，不要随意创造。
* 界面上所有内容使用中文
* 原有代码中已有的功能，与本次修改功能无关，或者不冲突的，一律不准有任何修改。
* 预处理的结果必须与现在脚本中的完全一样，不要因为效率导致了错误
* 所有的try except必须输出完整错误栈
* 数据库连接信息在util/db_util.py, 数据结构在sql_model/目录中可以看到，数据库初始化脚本在init_db.py中



我观察系统日志，以及显存空间发现几个问题
1. init_login中预先载入模型了之后，并没有放到GPU
2. 评估按钮点击之后所使用的模型可能不是预先载入的，可能进行了多余的二次载入

我需要你帮我分析一下代码，并且看一下有没有这些问题，有这些问题的话帮我修复了
日志情况：
2025-01-31 19:29:23,046 - INFO - 初始化登录界面...
2025-01-31 19:29:23,048 - INFO - 开始预加载模型...
2025-01-31 19:29:23,048 - INFO - 正在检查数据库中的模型信息...
2025-01-31 19:29:23,053 - INFO - 找到模型信息: model_type=0, path=./model/yingji/subject-1_yingji_quantized.tflite
2025-01-31 19:29:23,053 - INFO - 模型文件存在，开始加载...
2025-01-31 19:29:23,053 - INFO - 开始加载INT8量化模型...
2025-01-31 19:29:23,053 - INFO - 检测到可用GPU: ['/physical_device:GPU:0']
2025-01-31 19:29:23,053 - INFO - 已配置GPU: /physical_device:GPU:0
2025-01-31 19:29:23,054 - INFO - 开始加载模型文件: ./model/yingji/subject-1_yingji_quantized.tflite
2025-01-31 19:29:23,091 - INFO - 模型输入shape: [   1    1   59 1000], 类型: <class 'numpy.int8'>
2025-01-31 19:29:23,092 - INFO - 模型输出shape: [1 2], 类型: <class 'numpy.int8'>
2025-01-31 19:29:23,092 - INFO - 模型加载成功
2025-01-31 19:29:23,092 - INFO - 成功预加载量化模型
2025-01-31 19:29:25,776 - INFO - Opening user login page.
2025-01-31 19:29:29,779 - INFO - User admin logged in successfully
2025-01-31 19:29:30,905 - INFO - Administrator admin: fetching all data records
2025-01-31 19:29:30,930 - INFO - Successfully displayed 33 data records
2025-01-31 19:29:30,936 - INFO - Opening health evaluation page.
2025-01-31 19:29:35,507 - INFO - Prediction result: 1.0
2025-01-31 19:29:39,636 - INFO - Updated LED colors based on scores: stress=95.0, depression=0.0, anxiety=0.0

在点击评估按钮的时候系统也有输出错误，是不是又额外的predict函数调用：
2025-01-31 19:29:35,507 - INFO - Prediction result: 1.0
Error during prediction: Model not loaded. Please call load_static_model() first.
Traceback (most recent call last):
  File "/home/jupiter/bj_health_manage/model/tuili.py", line 158, in predict
    raise Exception("Model not loaded. Please call load_static_model() first.")
Exception: Model not loaded. Please call load_static_model() first.
Error during prediction: Model not loaded. Please call load_static_model() first.
Traceback (most recent call last):
  File "/home/jupiter/bj_health_manage/model/tuili.py", line 158, in predict
    raise Exception("Model not loaded. Please call load_static_model() first.")
Exception: Model not loaded. Please call load_static_model() first.
2025-01-31 19:29:39,636 - INFO - Updated LED colors based on scores: stress=95.0, depression=0.0, anxiety=0.0






