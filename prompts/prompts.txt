我希望用户管理数据库表字段设计成这样：
表：tb_user
字段名	数据类型	长度	是否允许空值	默认值	备注
user_id	varchar	64	否		用户ID，主键
username	varchar	50	否		用户名
password	varchar	64	否		用户密码（加密存储）
email	varchar	100	否		用户邮箱
phone	varchar	20	是	NULL	用户电话号码
full_name	varchar	255	是	NULL	用户全名
user_type	varchar	10	否	'user'	用户类型 ('admin' 或 'user')
last_login	datetime		是	NULL	上次登录时间
created_at	datetime		否	CURRENT_TIMESTAMP	用户创建时间
updated_at	datetime		是	CURRENT_TIMESTAMP	用户信息更新时间

对应的用户相关的接口功能和展示都要有改动。
并且修改对应的readme文档。
数据库初始化插入的数据仍然要保留，增加的字段就给一些默认的测试值就行了。
说中文

界面功能不要有太多变化。只改动和这个表相关的功能就行。并且一定要保证不出错，仔细检查。
最后自动帮我进行表的初始化。

tb_user的初始化sql也要有对应的修改。

mysql 用户名root，密码root，端口3306和ip 127.0.0.1










(301) PS D:\work\东华\项目\2023\301\changhang\start\bj_health_manage\rear> python .\init_login.py
2024-11-26 15:03:24.865912: I tensorflow/core/util/port.cc:153] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2024-11-26 15:03:26.011209: I tensorflow/core/util/port.cc:153] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
QLayout: Attempting to add QLayout "" to QWidget "centralwidget", which already has a layout
QLayout: Attempting to add QLayout "" to QWidget "centralwidget", which already has a layout
Traceback (most recent call last):
  File "D:\work\东华\项目\2023\301\changhang\start\bj_health_manage\rear\..\rear\admin_rear.py", line 112, in open_health_evaluate
    self.health_evaluate = health_evaluate_rear.Health_Evaluate_WindowActions()
  File "D:\work\东华\项目\2023\301\changhang\start\bj_health_manage\rear\..\rear\health_evaluate_rear.py", line 62, in __init__
    self.user_type = self.get_user_type(self.user_id)
  File "D:\work\东华\项目\2023\301\changhang\start\bj_health_manage\rear\..\rear\health_evaluate_rear.py", line 113, in get_user_type
    user = session.query(User).filter(User.id == user_id).first()
AttributeError: type object 'User' has no attribute 'id'

现在登录正确了。但是与tb_user相关的功能都需要重新查看，因为你现在修改了tb_user的表结构了。
你已经修改了tb_user的数据库表结构了，看看其他使用了这张表的部分是否要做对应的修改。



点击结果查看，提示错误：
(301) PS D:\work\东华\项目\2023\301\changhang\start\bj_health_manage\rear> python .\init_login.py
2024-11-26 16:23:11.620584: I tensorflow/core/util/port.cc:153] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2024-11-26 16:23:15.126824: I tensorflow/core/util/port.cc:153] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
QLayout: Attempting to add QLayout "" to QWidget "centralwidget", which already has a layout
QLayout: Attempting to add QLayout "" to QWidget "centralwidget", which already has a layout
QLayout: Attempting to add QLayout "" to QWidget "centralwidget", which already has a layout
QLayout: Attempting to add QLayout "" to QWidget "centralwidget", which already has a layout
Traceback (most recent call last):
  File "D:\work\东华\项目\2023\301\changhang\start\bj_health_manage\rear\..\rear\admin_rear.py", line 139, in open_results_view
    self.results_view = results_view_rear.Results_View_WindowActions()
  File "D:\work\东华\项目\2023\301\changhang\start\bj_health_manage\rear\..\rear\results_view_rear.py", line 60, in __init__
    self.user_type = self.get_user_type(self.user_id)
  File "D:\work\东华\项目\2023\301\changhang\start\bj_health_manage\rear\..\rear\results_view_rear.py", line 83, in get_user_type
    user = session.query(User).filter(User.id == user_id).first()
AttributeError: type object 'User' has no attribute 'id'








现在点击结果查看出现错误：
(301) PS D:\work\东华\项目\2023\301\changhang\start\bj_health_manage\rear> python .\init_login.py
>>
2024-11-26 16:29:30.190346: I tensorflow/core/util/port.cc:153] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2024-11-26 16:29:31.385536: I tensorflow/core/util/port.cc:153] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
QLayout: Attempting to add QLayout "" to QWidget "centralwidget", which already has a layout
QLayout: Attempting to add QLayout "" to QWidget "centralwidget", which already has a layout
QLayout: Attempting to add QLayout "" to QWidget "centralwidget", which already has a layout
QLayout: Attempting to add QLayout "" to QWidget "centralwidget", which already has a layout
Traceback (most recent call last):
  File "D:\work\东华\项目\2023\301\changhang\start\bj_health_manage\rear\..\rear\admin_rear.py", line 139, in open_results_view
    self.results_view = results_view_rear.Results_View_WindowActions()
  File "D:\work\东华\项目\2023\301\changhang\start\bj_health_manage\rear\..\rear\results_view_rear.py", line 78, in __init__
    self.btn_delete.clicked.connect(self.delete_result)  # 删除结果
AttributeError: 'Results_View_WindowActions' object has no attribute 'btn_delete'









点击结果查看，提示显示表格失败: foreign key associated with colum ' tb_result.user_id' could not find table 'tb_user' with which to generatea foreighn key to target column 'user_id'







去除结果查看中的删除结果按钮，现在结果不允许删除。




在数据查看页面，我登录的用户id是admin001，但是并没有看到表格中admin001所上传的数据。
还是没有看到对应用户所上传的数据。








用户登陆时，登录的session保存在'../state/user_status.txt'中。这个有没有适应新的tb_user表结构？并且保存的user_id是否正确？我现在登录admin用户（user_id=admin001)还是看不到上传的数据。




数据查看页面还是没有找到正确的登录用户id，并显示已上传的数据。并且如果是管理员用户登录的话我希望能够看到所有结果和数据。data_view_rear.py中读取'../state/user_status.txt'获得当前登录用户id可能有问题，当前登录用户id保存在current_user.txt中



点击修改密码页面，提示错误：
Traceback (most recent call last):
  File "D:\work\东华\项目\2023\301\changhang\start\bj_health_manage\rear\..\rear\admin_rear.py", line 157, in open_change_pwd_view
    self.change_pwd = change_pwd_controller.change_pwd_Controller()
  File "D:\work\东华\项目\2023\301\changhang\start\bj_health_manage\rear\..\rear\change_pwd_controller.py", line 32, in __init__
    self.setupUi(self)
AttributeError: 'change_pwd_Controller' object has no attribute 'setupUi'





修改密码页面现在是全空白的。我希望你在这个页面实现修改密码的功能。










现在每一个页面展示好像是销毁原有页面，然后再重建页面的。这样可能有问题。因为我比如在主页最大化了之后再进入新的一个页面之后，会变回窗口化。所以我希望你优化这一点，优化页面跳转的逻辑。




没有变化。现在页面跳转的时候还是会从最大换变回窗口化











禁止所有页面最大化



我希望登录页面也不要有最大化按钮。包括登陆页面中输入用户名也密码的页面，不要有最大化按钮，禁止窗口最大化。



模型管理、日志管理和密码修改页面的最大化按钮还是可用的。












我希望模型输出结果中有输出各个应激类型的概率（应激、抑郁、焦虑）分数在0-100之间，从模型预测结果中得到。并展示在健康评估界面上。




应激评估页面查看不到已上传数据。其中管理员可以查看所有数据，非管理员只能查看自己上传的数据。上传数据的用户id是tb_data的user_id



现在我用admin001用户登录（user_id=admin001，并且是管理员），还是看不到任何数据。





查看模型结果中的各个应激类型的概率（应激、抑郁、焦虑）分数在0-100之间，不要百分号。并且分数为出来结果列表中1的数量的占比*100。


模型结果中各应激类型的概率是num*100,num是 num = (y_pred.argmax(axis=-1).sum())/len(y_pred)，tuili.py中的



我希望登录页面，密码框输入回车，就等于点击登录按钮。现在没有这个操作绑定。






我希望在数据查看页面，每次上传数据之后，数据那一栏有一个预处理按钮。可以进行数据的预处理（                        data_pretreatment.treat(data_path)
）
以及进行数据特征的处理和保存（
                            try:
                                data_out.analyze_eeg_data(file_path)
                                logging.info(f"Visualization completed for file: {file_path}")
                                QMessageBox.information(self, "信息", "可视化成功完成")
                            except Exception as e:
                                logging.error(f"Error during visualization: {str(e)}")
                                QMessageBox.warning(self, "警告", f"可视化过程中出现错误: {str(e)}")

）

这两个过程要一起进行，通过这一个按钮来控制。










数据预处理和特征提取按钮点击之后前端会等待未响应，并且跳出这个框。要等到处理完成了系统才能用。我希望不要卡死，并且可以出来一个进度条提示用户等待。







我希望上传时不要输入用户名，user_id以及各种信息就绑定当前登录用户的信息。
并且上传之后的数据目录复制到data目录中去，数据库中保存的路径也要记录data目录中所记录的路径
并且界面上展示目录路径的时候只展示最后一个目录的名称，前面的完整路径不需要，也就是展示在data目录里的名称。




显示路径里，要显示最后一个\或者/之后的字符串。并且数据路径在显示的时候要完整显示，表格里给的宽度要足够






结果查看页面点击返回后也会直接退出程序。我希望你帮我再看看其他页面有没有同样的问题





现在所有页面点击返回按钮之后系统会直接退出，我希望你解决这个问题，不要出现点击返回闪退的情况。像是在主页点击能够进入的页面，点击返回之后应该进入主页。














评估页面看不到已经上传的数据。如果是管理员的话能看到所有数据，如果是普通用户只能看到自己上传的数据。数据路径显示要显示最后一个\或者/之后的字符串。并且数据路径在显示的时候要完整显示，表格里给的宽度要足够









这个预处理逻辑只考虑了edf数据（未进行预处理），有可能传入的数据已经与处理了（保存成fif.fif），如果没有未预处理的数据，只有已经预处理的数据则直接跳过预处理过程就行，将fif数据保存到fif.fif就行





用户管理界面中不应该显示用户密码，并且用户角色没有显示到对应的位置，操作下面也不是正确的内容。邮箱要可以为空的。修改用户信息界面里，需要弹出个框进行修改。创建用户的界面也需要根据数据库里的内容进行增加。



我需要数据库中重建这张表，帮我修改sql_model.sql以及tb_user.py，并且告诉我用什么命令可以重建这张表，并且进行这张表的初始化。






结果查看页面，下面的表中普通应激、抑郁、焦虑应为数据库里的原值。并且右边需要有一个查看按钮，点击后右上角可以看到特征图，这个特征图展示的逻辑和应激评估页面（health_evaluate_rear.py)里的一致。左上角当前评估结果显示三个状态，>=50圆形变成红色，否则就是灰色。当下面表中结果太多了的时候可以通过上下滑动查看。






结果查看中点击表格中的查看，应该左上角的结果显示评估状态：左上角当前评估结果显示三个状态，对应result1-3，>=50圆形变成红色，否则就是灰色。右上角的图片展示默认展示Theta特征图像，图像上面显示标题，可以参考应激评估页面（health_evaluate_rear.py）中的展示方式。


右上角的特征图像不要通过下拉菜单选择，要点击prev和next进行切换，上方显示图片标题。



结果查看页面中，点击了表格中的查看之后，左上角评估状态不仅要变颜色，也要显示result1-3的分数，放到文字后面，括号里。



结果查看页面中，点击了表格中的查看之后，右上角的文字要是特征的名称，要随着prev和next按钮有变化。









用户的密码要进行sha256的加密，注意登录、用户注册、用户修改密码的时候都需要进行加密，登陆时需要加密后验证。

sql初始化时插入的密码也进行sha256加密



数据查看页面，缩小上传按钮，并且增加一个批量上传按钮，批量上传按钮可以把一个目录下所有子目录都循环使用上传功能进行上传。上面是上传按钮，下面是批量上传按钮。



点击批量上传并没有上传成功，我希望实现的是，点击批量上传选择了/path/之后，把/path/下的所有/path/a,/path/目录（a,b必须要是目录）都调用上传功能进行依次上传。




我批量上传了5个数据了之后，数据查看页面里的表格中只会出来一个最新的数据。4个数据在数据库里已经插入了，但是并没有显示在表格中。根据用户权限显示记录。管理员可以看到所有数据，普通用户只能看到当前用户所上传的数据，这个逻辑再现有代码里应该已经有了。并且新上传的所有数据必须显示在表格中。




你看一下这里，我点击了批量上传了，上传了/tmp/目录下的5个目录的数据，但是表格中只能看到一个。







数据上传（不是批量上传）功能是否能够开放一个http的post接口服务，让外部服务可以通过接口上传数据？外部服务上传一个zip文件（二进制文件），参数还有用户id(user_id)，然后系统下载到tmp目录中，解压缩后放到data目录中，接下来的流程就和上传一样了，如果有重名的就加后缀重命名。然后在数据库里记录一下。







在health_evaluate_rear中，在533-534行
        probability_score = float(num) * 100  # 将num*100改为num*95，使得最大值为95
        probability_score = max(0, min(95, probability_score))  # 确保分数在0-95之间
后，得到了数据之后我希望有多模态数据融合处理的逻辑，对分数进行改动
首先，检查是否有量表数据存在(lb.csv)，如果有的话使用pandas读取lb.csv(第一行为title，第二行为数据，逗号分隔）
把前20列的数据加在一起得到数值x, 得到分数1 score_lb_1=(x-48)/80*3
把后20列的数据加在一起得到数值x, 得到分数2 score_lb_2=(x-53)/80*3

然后检查是否有血清学数据（xq.csv），如果有的话使用pandas读取xq.csv(第一行为title，第二行为数据，逗号分隔）
把所有列的值（去除"<",">","≤","≥"，转float）求和，结果/5000得到分数3（score_xq）

针对普通应激分数，最终分数为probability_score+score_xq
针对抑郁分数，最终分数为probability_score+score_lb_1
针对焦虑分数，最终分数为probability_score+score_lb_2





在根目录新建一个python文件，能够代替
cd rear
python init_login.py





点击应激评估，针对数据如果找不到，或者格式错误的时候会提示：
['2024-12-04 16:15:06']
Traceback (most recent call last):
  File "D:\work\东华\项目\2023\301\changhang\start\bj_health_manage\rear\..\model\tuili.py", line 113, in run
    result = self.predict()
  File "D:\work\东华\项目\2023\301\changhang\start\bj_health_manage\rear\..\model\tuili.py", line 102, in predict
    X_test = self.get_data()
  File "D:\work\东华\项目\2023\301\changhang\start\bj_health_manage\rear\..\model\tuili.py", line 80, in get_data
    data = exp_data[-(num_of_data)::, ::, ::]
UnboundLocalError: local variable 'exp_data' referenced before assignment






我现在希望评估结果之后，在应激评估页面增加一个生成报告按钮（每行数据有一个），点击按钮之后生成docx的报告。生成逻辑如下：
# 1. 读取模板文件template.docx文件
其中模板文件的内容如下：
应激评估报告
1.用户基本信息
用户名：[user.username]
邮箱：[user.email]
手机：[user.phone]
用户创建时间：[user.created_at]

2.应激评估信息
普通应激评分：[normal_yingji.score], 评估结果：[normal_yingji.result]
抑郁评分：[depression.score], 评估结果：[depression.result]
焦虑评分：[stress.score], 评估结果：[stress.result]

3.评估数据可视化
3.1 脑电信号
[signals.eeg]
3.2 血清数据
[signals.blood]
3.3 量表数据
[signals.scale]
4.防护建议
[suggest]

# 2. 对模板中的内容进行替换：
[user.username] 替换数据上传用户的用户名
[user.email] 替换数据上传用户的邮箱
[user.phone] 替换数据上传用户的手机号
[user.created_at] 替换数据上传用户的用户创建时间

[normal_yingji.score] 替换对应评估结果中的普通应激评分result1
[normal_yingji.result] 在result1>=50的时候为"可能存在应激情况"，否则为"低概率存在应激情况"
[depression.score] 替换对应评估结果中的普通应激评分result2
[normal_yingji.result] 在result1>=50的时候为"可能存在抑郁情况"，否则为"低概率存在抑郁情况"
[stress.score] 替换对应评估结果中的普通应激评分result3
[normal_yingji.result] 在result1>=50的时候为"可能存在焦虑情况"，否则为"低概率存在焦虑情况"

生成的报告保存在data/results目录中，用result id命名




在生成的报告的[signals.eeg]替换图，图文件对应：
            self.image_list = [
                "Theta.png", "Alpha.png", "Beta.png", "Gamma.png",
                "frequency_band_1.png", "frequency_band_2.png", "frequency_band_3.png", "frequency_band_4.png", "frequency_band_5.png",
                "time_过零率.png", "time_方差.png", "time_能量.png", "time_差分.png",
                "frequency_wavelet.png", "differential_entropy.png"
            ]

每个图的名称对应：
            image_names = [
                "Theta波段功率", "Alpha波段功率", "Beta波段功率", "Gamma波段功率",
                "均分频带1", "均分频带2", "均分频带3", "均分频带4", "均分频带5",
                "域特征 - 过零率", "时域特征 - 方差", "时域特征 - 能量", "时域特征 - 差分",
                "时频域特征 - 小波变换", "微分熵"
            ]
名称+：要显示在图的上一行。











tb_result结果表中，result1改成stress_score，类型为float，代表普通应激分数；result2改为depression_score，类型为float，代表抑郁分数；result3改为anxiety_score，类型为float，代表焦虑分数；另外增加report_path，备注为报告路径，存储生成报告的路径。

在应激评估页面中，要求必须有应激结果并且有3个分数的情况下才能够生成应激报告，否则弹出提示。生成了docx报告之后，自动将docx报告转换成pdf，文件名相同。docx和pdf的报告文件名都要是result_id。report_path存储pdf文件路径。原本生成报告中template内容填充的代码不要有任何删除（health_evaluate_rear.py line 771 - line 896） generateReport函数


在结果展示中，最右侧增加查看报告按钮，点击打开一个页面，可以查看生成的pdf文件，并且有一个下载按钮，弹出框允许用户把pdf报告保存到指定目录中。按钮要增加到原本查看按钮的右边（rear\results_view_rear.py, line 287)







result_view_rear.py中新增加的buttonForRow的查看功能，并在line 286-line 302行已经定义过了，新的"查看报告"按钮在这里定义就行了，不要重新再构建一个buttonForRow函数。或者把一行中所有的button都放到这个函数里，并且查看按钮在301行调用了self.view_details函数，这个功能不能缺少，最好要保持原状。



result_view_rear.py中的result1-3都在数据库表的列都变成了stress_score,depression_score,anxiety_score



能否在result_view_rear.py页面中点击row的查看报告的时候，将pdf报告转换成图像然后展示在弹出的窗口中展示图像（可放大缩小），点击弹出窗口下方的下载报告按钮，将pdf报告下载到指定目录中。







点击"报告按钮"生成报告的时候，显示进度条，完成后不要提示具体报告保存路径，提示：报告生成完毕，可以在结果管理中查看。